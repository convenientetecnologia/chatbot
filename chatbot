function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
      .setWidth(400)
      .setHeight(300);
}

function registrarPedidoInicial(cidade, telefone) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Pedidos");
    if (!sheet) {
      console.log("Planilha 'Pedidos' não encontrada.");
      return;
    }
    const ultimaLinha = sheet.getLastRow() + 1;
    const dataHora = new Date();
    sheet.getRange(`A${ultimaLinha}`).setValue(dataHora);
    sheet.getRange(`B${ultimaLinha}`).setValue(telefone);
    sheet.getRange(`C${ultimaLinha}`).setValue(cidade);
    const pedidoId = `pedido_${new Date().getTime()}`;
    sheet.getRange(`L${ultimaLinha}`).setValue(pedidoId);
    sheet.getRange(`K${ultimaLinha}`).setValue("Pendente");
    return pedidoId;
  } catch (error) {
    console.error("Erro ao registrar pedido: ", error);
  }
}

function registrarPedidoParcial(pedidoId, coluna, valor) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Pedidos");
  const dados = sheet.getDataRange().getValues();
  const linha = dados.findIndex(row => row[11] === pedidoId) + 1;
  if (linha > 0) {
    sheet.getRange(`${coluna}${linha}`).setValue(valor);
  } else {
    console.log(`Pedido não encontrado: ${pedidoId}`);
  }
}

function verificarPedidosPeriodicamente() {
  const sheetPedidos = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Pedidos");
  const sheetFinalizados = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Finalizados");
  const planilhaDestino = SpreadsheetApp.openById("1QfDoC2a9utUN8SliAp4iTmHViz9XiKW33JbpVy1F_mM");
  const sheetNotificacao = planilhaDestino.getSheetByName("Notificação Whatsapp");
  const dados = sheetPedidos.getDataRange().getValues();
  const idsProcessados = [];

  for (let i = dados.length - 1; i > 0; i--) {
    const status = dados[i][10]; // Coluna K (zero-indexed)
    const pedidoId = dados[i][11]; // Coluna L (zero-indexed)
    const pedido = dados[i];
    const dadosPedido = sheetPedidos.getRange(`A${i+1}:I${i+1}`).getValues()[0];
    const mensagem = criarMensagemWhatsapp(pedido);

    if (idsProcessados.includes(pedidoId)) {
      console.log(`Pedido já processado: ${pedidoId}`);
      continue;
    }

    if (status === "Concluído" || (status === "Pendente" && isMaisDe5Minutos(pedido[0]))) {
      sheetFinalizados.appendRow(dadosPedido);
      sheetNotificacao.appendRow([pedido[2], mensagem]); // Corrigido: Telefone em pedido[2], Mensagem
      sheetPedidos.deleteRow(i + 1);
      console.log(`Pedido movido para finalizados e notificação enviada: ${pedidoId}`);
      idsProcessados.push(pedidoId);
    }
  }
}

function isMaisDe5Minutos(dataHora) {
  const agora = new Date();
  const diferencaMinutos = (agora - new Date(dataHora)) / (1000 * 60);
  return diferencaMinutos >= 5;
}

function criarMensagemWhatsapp(pedido) {
  const ajudante = pedido[3];
  const bairroSaida = pedido[6];
  const bairroDestino = pedido[7];
  const enderecoSaida = pedido[4];
  const enderecoDestino = pedido[5];
  const tipo = `De ${enderecoSaida} para ${enderecoDestino}`;
  const transporte = pedido[8];
  const telefone = pedido[1]; // Certifique-se de que o índice está correto

  // Converte o telefone para string caso não seja
  let telefoneStr = telefone ? telefone.toString() : '';
  
  // Remove caracteres não numéricos
  telefoneStr = telefoneStr.replace(/\D/g, '');
  
  // Remove o '9' se for o primeiro dígito após o DDD
  if (telefoneStr.length === 11 && telefoneStr[2] === '9') {
    telefoneStr = telefoneStr.slice(0, 2) + telefoneStr.slice(3);
  }
  
  // Adiciona o código do país
  telefoneStr = `55${telefoneStr}`;

  const mensagemWhatsapp = "Olá, recebi sua solicitação de frete ou mudança e vou iniciar o seu atendimento";
  const linkWhatsapp = `https://wa.me/${telefoneStr}?text=${encodeURIComponent(mensagemWhatsapp)}`;
  
  return `Nova solicitação!\nPrecisa de ajudante? ${ajudante}\nBairro de saída: ${bairroSaida}\nBairro de destino: ${bairroDestino}\nTipo: ${tipo}\nDescrição: ${transporte}\nTelefone: ${telefoneStr}\n\nLink para contatar o cliente: ${linkWhatsapp}`;
}

function obterCidades() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Cidades");
  const dados = sheet.getDataRange().getValues();
  return dados.map(linha => ({ nome: linha[0], estado: linha[1] })).filter(c => c.nome && c.estado);
}

function obterEstados() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Estados");
  const dados = sheet.getRange('A:A').getValues();
  return dados.map(row => row[0]).filter(e => e);
}

function concluirPedido(pedidoId) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Pedidos");
  const dados = sheet.getDataRange().getValues();
  const linha = dados.findIndex(row => row[11] === pedidoId) + 1;
  if (linha > 0) {
    sheet.getRange(`K${linha}`).setValue("Concluído");
  }
}
